{
  "$schema": "../../tests.schema.json",
  "metadata": {
    "name": "Advanced Reference Resolution Tests",
    "version": "1.0.0",
    "description": "Tests for complex reference resolution scenarios including nested scopes and cross-references",
    "category": "linking"
  },
  "tests": [
    {
      "id": "nested_subgraph_references",
      "title": "Nested Subgraph References",
      "description": "Verify that references work correctly across nested subgraph scopes",
      "feature": "node_reference_resolution",
      "tags": ["references", "nested", "subgraphs"],
      "inputs": {
        "neuro_model": {
          "$schema": "https://raw.githubusercontent.com/neuro-format/schemas/2025-1/neuro.schema.json",
          "metadata": {
            "model": {
              "name": "nested_references",
              "version": "1.0.0"
            }
          },
          "inputs": [
            {"name": "input", "shape": [10], "dtype": "float32"}
          ],
          "outputs": [
            {"name": "output", "shape": [5], "dtype": "float32"}
          ],
          "definitions": [
            {
              "name": "outer_layer",
              "type": "sequential",
              "arguments": [{"name": "x", "type": "tensor"}],
              "implementation": {
                "graph": {
                  "nodes": [
                    {
                      "name": "inner_transform",
                      "type": "this:inner_layer",
                      "arguments": ["@{arguments.x}"]
                    }
                  ]
                }
              }
            },
            {
              "name": "inner_layer", 
              "type": "sequential",
              "arguments": [{"name": "y", "type": "tensor"}],
              "implementation": {
                "graph": {
                  "nodes": [
                    {
                      "name": "linear1",
                      "type": "this:linear",
                      "arguments": ["@{arguments.y}"],
                      "attributes": {"in_features": 10, "out_features": 5}
                    }
                  ]
                }
              }
            }
          ],
          "export": [
            {"name": "main", "type": "this:outer_layer", "arguments": ["@{arguments.input}"]}
          ]
        }
      },
      "expected": {
        "success": true,
        "validation_result": true
      }
    },
    {
      "id": "cross_definition_references",
      "title": "Cross Definition References",
      "description": "Verify that definitions can reference other definitions correctly",
      "feature": "node_reference_resolution",
      "tags": ["references", "definitions", "cross-reference"],
      "inputs": {
        "neuro_model": {
          "$schema": "https://raw.githubusercontent.com/neuro-format/schemas/2025-1/neuro.schema.json",
          "metadata": {
            "model": {
              "name": "cross_references",
              "version": "1.0.0"
            }
          },
          "inputs": [
            {"name": "input", "shape": [10], "dtype": "float32"}
          ],
          "outputs": [
            {"name": "output", "shape": [1], "dtype": "float32"}
          ],
          "definitions": [
            {
              "name": "encoder",
              "type": "sequential",
              "arguments": [{"name": "x", "type": "tensor"}],
              "implementation": {
                "graph": {
                  "nodes": [
                    {"name": "encode", "type": "this:linear", "arguments": ["@{arguments.x}"], "attributes": {"in_features": 10, "out_features": 5}}
                  ]
                }
              }
            },
            {
              "name": "classifier",
              "type": "sequential", 
              "arguments": [{"name": "features", "type": "tensor"}],
              "implementation": {
                "graph": {
                  "nodes": [
                    {"name": "classify", "type": "this:linear", "arguments": ["@{arguments.features}"], "attributes": {"in_features": 5, "out_features": 1}}
                  ]
                }
              }
            },
            {
              "name": "full_model",
              "type": "sequential",
              "arguments": [{"name": "input", "type": "tensor"}],
              "implementation": {
                "graph": {
                  "nodes": [
                    {"name": "encoded", "type": "this:encoder", "arguments": ["@{arguments.input}"]},
                    {"name": "result", "type": "this:classifier", "arguments": ["@{./encoded}"]}
                  ]
                }
              }
            }
          ],
          "export": [
            {"name": "main", "type": "this:full_model", "arguments": ["@{arguments.input}"]}
          ]
        }
      },
      "expected": {
        "success": true,
        "validation_result": true
      }
    },
    {
      "id": "invalid_cross_scope_reference",
      "title": "Invalid Cross Scope Reference",
      "description": "Verify that references to nodes in different scopes are properly rejected",
      "feature": "node_reference_resolution",
      "tags": ["references", "scopes", "validation", "error"],
      "inputs": {
        "neuro_model": {
          "$schema": "https://raw.githubusercontent.com/neuro-format/schemas/2025-1/neuro.schema.json",
          "metadata": {
            "model": {
              "name": "invalid_scope_ref",
              "version": "1.0.0"
            }
          },
          "inputs": [
            {"name": "input", "shape": [10], "dtype": "float32"}
          ],
          "outputs": [
            {"name": "output", "shape": [5], "dtype": "float32"}
          ],
          "definitions": [
            {
              "name": "layer_a",
              "type": "sequential",
              "arguments": [{"name": "x", "type": "tensor"}],
              "implementation": {
                "graph": {
                  "nodes": [
                    {"name": "hidden", "type": "this:linear", "arguments": ["@{arguments.x}"], "attributes": {"in_features": 10, "out_features": 5}}
                  ]
                }
              }
            },
            {
              "name": "layer_b",
              "type": "sequential",
              "arguments": [{"name": "y", "type": "tensor"}],
              "implementation": {
                "graph": {
                  "nodes": [
                    {"name": "invalid_ref", "type": "this:linear", "arguments": ["@{hidden}"], "attributes": {"in_features": 5, "out_features": 5}}
                  ]
                }
              }
            }
          ],
          "export": [
            {"name": "main", "type": "this:layer_b", "arguments": ["@{arguments.input}"]}
          ]
        }
      },
      "expected": {
        "error": {
          "code": "neuro.ref.node_not_found",
          "message_pattern": ".*hidden.*not.*found.*scope.*"
        }
      }
    },
    {
      "id": "deep_nested_valid_references",
      "title": "Deep Nested Valid References",
      "description": "Verify that deeply nested but valid references work correctly",
      "feature": "node_reference_resolution",
      "tags": ["references", "deep", "nested", "validation"],
      "inputs": {
        "neuro_model": {
          "$schema": "https://raw.githubusercontent.com/neuro-format/schemas/2025-1/neuro.schema.json",
          "metadata": {
            "model": {
              "name": "deep_nested",
              "version": "1.0.0"
            }
          },
          "inputs": [
            {"name": "input", "shape": [16], "dtype": "float32"}
          ],
          "outputs": [
            {"name": "output", "shape": [2], "dtype": "float32"}
          ],
          "definitions": [
            {
              "name": "level_3_block",
              "type": "sequential",
              "arguments": [{"name": "x", "type": "tensor"}],
              "implementation": {
                "graph": {
                  "nodes": [
                    {"name": "l3_linear", "type": "this:linear", "arguments": ["@{arguments.x}"], "attributes": {"in_features": 4, "out_features": 2}}
                  ]
                }
              }
            },
            {
              "name": "level_2_block",
              "type": "sequential",
              "arguments": [{"name": "x", "type": "tensor"}],
              "implementation": {
                "graph": {
                  "nodes": [
                    {"name": "l2_linear", "type": "this:linear", "arguments": ["@{arguments.x}"], "attributes": {"in_features": 8, "out_features": 4}},
                    {"name": "l2_to_l3", "type": "this:level_3_block", "arguments": ["@{./l2_linear}"]}
                  ]
                }
              }
            },
            {
              "name": "level_1_block",
              "type": "sequential",
              "arguments": [{"name": "x", "type": "tensor"}],
              "implementation": {
                "graph": {
                  "nodes": [
                    {"name": "l1_linear", "type": "this:linear", "arguments": ["@{arguments.x}"], "attributes": {"in_features": 16, "out_features": 8}},
                    {"name": "l1_to_l2", "type": "this:level_2_block", "arguments": ["@{./l1_linear}"]}
                  ]
                }
              }
            }
          ],
          "export": [
            {"name": "main", "type": "this:level_1_block", "arguments": ["@{arguments.input}"]}
          ]
        }
      },
      "expected": {
        "success": true,
        "validation_result": true
      }
    }
  ]
}
