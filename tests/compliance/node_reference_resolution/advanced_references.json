{
  "$schema": "../../tests.schema.json",
  "metadata": {
    "name": "Advanced Reference Resolution Tests",
    "version": "1.0.0",
    "modalities": {
      "inputs": ["custom"],
      "outputs": ["custom"]
    },
    "description": "Tests for complex reference resolution scenarios including nested scopes and cross-references",
    "category": "linking"
  },
  "tests": [
    {
      "id": "nested_subgraph_references",
      "title": "Nested Subgraph References",
      "description": "Verify that references work correctly across nested subgraph scopes",
      "feature": "node_reference_resolution",
      "tags": ["references", "nested", "subgraphs"],
      "inputs": {
        "neuro_model": {
          "$schema": "https://raw.githubusercontent.com/neuro-graph/schemas/latest/neuro.schema.json",
          "metadata": {
            "model": {
              "name": "nested_references",
              "version": "1.0.0",
              "modalities": {
                "inputs": ["custom"],
                "outputs": ["custom"]
              }
            }
          },
          "inputs": [{ "name": "input", "shape": [10], "dtype": "float32" }],
          "outputs": [{ "name": "output", "shape": [5], "dtype": "float32" }],
          "definitions": [
            {
              "name": "outer_layer",
              "type": "sequential",
              "arguments": [{ "name": "x", "type": "tensor" }],
              "subgraph": [
                {
                  "name": "inner_transform",
                  "type": "inner_layer",
                  "arguments": ["@{arguments.x}"]
                }
              ],
              "outputs": [
                {
                  "name": "result",
                  "description": "Output from inner layer transformation",
                  "source": "@{inner_transform}"
                }
              ]
            },
            {
              "name": "inner_layer",
              "type": "sequential",
              "arguments": [{ "name": "y", "type": "tensor" }],
              "subgraph": [
                {
                  "name": "linear1",
                  "type": "linear",
                  "arguments": ["@{arguments.y}"],
                  "attributes": { "in_features": 10, "out_features": 5 }
                }
              ],
              "outputs": [
                {
                  "name": "transformed",
                  "description": "Linear transformation result",
                  "source": "@{linear1}"
                }
              ]
            }
          ],
          "export": [
            {
              "name": "main",
              "type": "outer_layer",
              "arguments": ["@{arguments.input}"]
            }
          ]
        }
      },
      "expected": {
        "success": true,
        "validation_result": true
      }
    },
    {
      "id": "cross_definition_references",
      "title": "Cross Definition References",
      "description": "Verify that definitions can reference other definitions correctly",
      "feature": "node_reference_resolution",
      "tags": ["references", "definitions", "cross-reference"],
      "inputs": {
        "neuro_model": {
          "$schema": "https://raw.githubusercontent.com/neuro-graph/schemas/latest/neuro.schema.json",
          "metadata": {
            "model": {
              "name": "cross_references",
              "version": "1.0.0",
              "modalities": {
                "inputs": ["custom"],
                "outputs": ["custom"]
              }
            }
          },
          "inputs": [{ "name": "input", "shape": [10], "dtype": "float32" }],
          "outputs": [{ "name": "output", "shape": [1], "dtype": "float32" }],
          "definitions": [
            {
              "name": "encoder",
              "type": "sequential",
              "arguments": [{ "name": "x", "type": "tensor" }],
              "subgraph": [
                {
                  "name": "encode",
                  "type": "linear",
                  "arguments": ["@{arguments.x}"],
                  "attributes": { "in_features": 10, "out_features": 5 }
                }
              ],
              "outputs": [
                {
                  "name": "encoded_features",
                  "description": "Encoded features from linear layer",
                  "source": "@{encode}"
                }
              ]
            },
            {
              "name": "classifier",
              "type": "sequential",
              "arguments": [{ "name": "features", "type": "tensor" }],
              "subgraph": [
                {
                  "name": "classify",
                  "type": "linear",
                  "arguments": ["@{arguments.features}"],
                  "attributes": { "in_features": 5, "out_features": 1 }
                }
              ],
              "outputs": [
                {
                  "name": "classification_result",
                  "description": "Classification output",
                  "source": "@{classify}"
                }
              ]
            },
            {
              "name": "full_model",
              "type": "sequential",
              "arguments": [{ "name": "input", "type": "tensor" }],
              "subgraph": [
                {
                  "name": "encoded",
                  "type": "encoder",
                  "arguments": ["@{arguments.input}"]
                },
                {
                  "name": "result",
                  "type": "classifier",
                  "arguments": ["@{./encoded}"]
                }
              ],
              "outputs": [
                {
                  "name": "final_result",
                  "description": "Final model output",
                  "source": "@{result}"
                }
              ]
            }
          ],
          "export": [
            {
              "name": "main",
              "type": "full_model",
              "arguments": ["@{arguments.input}"]
            }
          ]
        }
      },
      "expected": {
        "success": true,
        "validation_result": true
      }
    },
    {
      "id": "invalid_cross_scope_reference",
      "title": "Invalid Cross Scope Reference",
      "description": "Verify that references to nodes in different scopes are properly rejected",
      "feature": "node_reference_resolution",
      "tags": ["references", "scopes", "validation", "error"],
      "inputs": {
        "neuro_model": {
          "$schema": "https://raw.githubusercontent.com/neuro-graph/schemas/latest/neuro.schema.json",
          "metadata": {
            "model": {
              "name": "invalid_scope_ref",
              "version": "1.0.0",
              "modalities": {
                "inputs": ["custom"],
                "outputs": ["custom"]
              }
            }
          },
          "inputs": [{ "name": "input", "shape": [10], "dtype": "float32" }],
          "outputs": [{ "name": "output", "shape": [5], "dtype": "float32" }],
          "definitions": [
            {
              "name": "layer_a",
              "type": "sequential",
              "arguments": [{ "name": "x", "type": "tensor" }],
              "subgraph": [
                {
                  "name": "hidden",
                  "type": "linear",
                  "arguments": ["@{arguments.x}"],
                  "attributes": { "in_features": 10, "out_features": 5 }
                }
              ],
              "outputs": [
                {
                  "name": "hidden_features",
                  "description": "Hidden layer output",
                  "source": "@{hidden}"
                }
              ]
            },
            {
              "name": "layer_b",
              "type": "sequential",
              "arguments": [{ "name": "y", "type": "tensor" }],
              "subgraph": [
                {
                  "name": "invalid_ref",
                  "type": "linear",
                  "arguments": ["@{hidden}"],
                  "attributes": { "in_features": 5, "out_features": 5 }
                }
              ],
              "outputs": [
                {
                  "name": "invalid_output",
                  "description": "Output with invalid reference",
                  "source": "@{invalid_ref}"
                }
              ]
            }
          ],
          "export": [
            {
              "name": "main",
              "type": "layer_b",
              "arguments": ["@{arguments.input}"]
            }
          ]
        }
      },
      "expected": {
        "error": {
          "code": "neuro.ref.node_not_found",
          "message_pattern": ".*hidden.*not.*found.*scope.*"
        }
      }
    },
    {
      "id": "deep_nested_valid_references",
      "title": "Deep Nested Valid References",
      "description": "Verify that deeply nested but valid references work correctly",
      "feature": "node_reference_resolution",
      "tags": ["references", "deep", "nested", "validation"],
      "inputs": {
        "neuro_model": {
          "$schema": "https://raw.githubusercontent.com/neuro-graph/schemas/latest/neuro.schema.json",
          "metadata": {
            "model": {
              "name": "deep_nested",
              "version": "1.0.0",
              "modalities": {
                "inputs": ["custom"],
                "outputs": ["custom"]
              }
            }
          },
          "inputs": [{ "name": "input", "shape": [16], "dtype": "float32" }],
          "outputs": [{ "name": "output", "shape": [2], "dtype": "float32" }],
          "definitions": [
            {
              "name": "level_3_block",
              "type": "sequential",
              "arguments": [{ "name": "x", "type": "tensor" }],
              "subgraph": [
                {
                  "name": "l3_linear",
                  "type": "linear",
                  "arguments": ["@{arguments.x}"],
                  "attributes": { "in_features": 4, "out_features": 2 }
                }
              ],
              "outputs": [
                {
                  "name": "level_3_result",
                  "description": "Level 3 block output",
                  "source": "@{l3_linear}"
                }
              ]
            },
            {
              "name": "level_2_block",
              "type": "sequential",
              "arguments": [{ "name": "x", "type": "tensor" }],
              "subgraph": [
                {
                  "name": "l2_linear",
                  "type": "linear",
                  "arguments": ["@{arguments.x}"],
                  "attributes": { "in_features": 8, "out_features": 4 }
                },
                {
                  "name": "l2_to_l3",
                  "type": "level_3_block",
                  "arguments": ["@{./l2_linear}"]
                }
              ],
              "outputs": [
                {
                  "name": "level_2_result",
                  "description": "Level 2 block output",
                  "source": "@{l2_to_l3}"
                }
              ]
            },
            {
              "name": "level_1_block",
              "type": "sequential",
              "arguments": [{ "name": "x", "type": "tensor" }],
              "subgraph": [
                {
                  "name": "l1_linear",
                  "type": "linear",
                  "arguments": ["@{arguments.x}"],
                  "attributes": { "in_features": 16, "out_features": 8 }
                },
                {
                  "name": "l1_to_l2",
                  "type": "level_2_block",
                  "arguments": ["@{./l1_linear}"]
                }
              ],
              "outputs": [
                {
                  "name": "level_1_result",
                  "description": "Level 1 block output",
                  "source": "@{l1_to_l2}"
                }
              ]
            }
          ],
          "export": [
            {
              "name": "main",
              "type": "level_1_block",
              "arguments": ["@{arguments.input}"]
            }
          ]
        }
      },
      "expected": {
        "success": true,
        "validation_result": true
      }
    }
  ]
}
